<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { /* Suas chaves aqui */ };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const btn = document.getElementById('btn');
    const statusTxt = document.getElementById('status');

    btn.onclick = function() {
        const id = document.getElementById('idPedido').value.trim();
        if(!id) { alert("Digite o n√∫mero do pedido!"); return; }

        statusTxt.innerText = "Solicitando permiss√£o do sistema...";
        
        // Configura√ß√µes de alta precis√£o
        const gpsOptions = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        };

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                btn.innerText = "SINAL ATIVO";
                btn.style.background = "#3b82f6";
                statusTxt.innerHTML = "<b style='color:#10b981'>üìç GPS CONECTADO!</b><br>Sinal enviado para o pedido: " + id;
                
                // Monitoramento cont√≠nuo
                navigator.geolocation.watchPosition((p) => {
                    update(ref(db, 'pedidos/' + id), { 
                        lat: p.coords.latitude, 
                        lng: p.coords.longitude,
                        ultimaAtualizacao: Date.now()
                    });
                }, null, gpsOptions);
            },
            (err) => {
                // SE O GPS ESTIVER BLOQUEADO, ELE AVISA AQUI:
                console.error(err);
                statusTxt.innerHTML = "<b style='color:#ef4444'>ERRO DE ACESSO AO GPS:</b><br>Clique no √≠cone de configura√ß√µes ao lado do link l√° no topo e mude 'Localiza√ß√£o' para PERMITIR.";
                alert("O GPS est√° bloqueado. Por favor, autorize nas configura√ß√µes do navegador.");
            }, 
            gpsOptions
        );
    };
</script>
