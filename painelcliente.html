<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acompanhe sua Entrega - Silenciosa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #111827; --accent: #10b981; --warning: #f59e0b; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; transition: background-color 0.5s ease; }
        #map { height: 100vh; width: 100vw; position: absolute; z-index: 1; }
        
        .info-card { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 380px; background: white; padding: 20px; 
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            z-index: 1000; text-align: center; border-bottom: 5px solid var(--accent);
        }

        .pulse { 
            height: 12px; width: 12px; background: var(--accent); 
            border-radius: 50%; display: inline-block; margin-right: 10px; 
            animation: p 1.5s infinite; 
        }

        @keyframes p { 
            0% { transform: scale(0.9); opacity: 1; } 
            100% { transform: scale(2.5); opacity: 0; } 
        }

        h4 { margin: 0; font-size: 1.1rem; color: var(--primary); }
        p { margin: 8px 0 0; color: #4b5563; font-size: 0.9rem; font-weight: 500; }
        
        /* Estilo para o alerta de chegada */
        .chegou { background-color: #fff9c4 !important; }
        .chegou .info-card { border-bottom: 5px solid #d32f2f; }
    </style>
</head>
<body>

    <div class="info-card">
        <h4 id="titulo"><span class="pulse"></span>Monitorando Entrega</h4>
        <p id="msg">Buscando sinal do motoboy...</p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWW6TL0TrXq35ei9XdJDwQxtmSk2C-u9Y",
            authDomain: "entregasilenciosa-34182.firebaseapp.com",
            databaseURL: "https://entregasilenciosa-34182-default-rtdb.firebaseio.com",
            projectId: "entregasilenciosa-34182",
            storageBucket: "entregasilenciosa-34182.firebasestorage.app",
            messagingSenderId: "412313322568",
            appId: "1:412313322568:web:232dcd285d40cb9b1cc47d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const urlParams = new URLSearchParams(window.location.search);
        const pedidoId = urlParams.get('id');

        // Inicializa mapa n칤tido do Google
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-15.78, -47.92], 4);
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(map);

        const iconMoto = L.icon({ 
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/71/71422.png', 
            iconSize: [40, 40], iconAnchor: [20, 20] 
        });

        let marker = null;
        let cliPos = null;
        let jaAvisou = false;

        // Tenta capturar localiza칞칚o do cliente para c치lculo de dist칙ncia
        navigator.geolocation.getCurrentPosition((c) => { 
            cliPos = { lat: c.coords.latitude, lng: c.coords.longitude }; 
        });

        function calcDist(l1, o1, l2, o2) {
            const R = 6371000; 
            const dLat = (l2-l1) * Math.PI/180;
            const dLon = (o2-o1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(l1*Math.PI/180) * Math.cos(l2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // Fun칞칚o de Chamada Sonora
        function tocarAlerta() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // Tom agudo
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.start();
                setTimeout(() => oscillator.stop(), 1200); // Toca por 1.2 segundos
            } catch (e) { console.log("Erro ao tocar 치udio"); }
        }

        if(pedidoId) {
            onValue(ref(db, 'pedidos/' + pedidoId), (snap) => {
                const data = snap.val();
                if(data && data.lat && data.lat !== 0) {
                    const pos = [data.lat, data.lng];
                    
                    if(!marker) { 
                        marker = L.marker(pos, {icon: iconMoto}).addTo(map); 
                        map.setView(pos, 16); 
                    } else { 
                        marker.setLatLng(pos); 
                    }
                    
                    // Garante que o mapa renderize corretamente
                    setTimeout(() => { map.invalidateSize(); }, 400);

                    if(cliPos) {
                        const d = calcDist(cliPos.lat, cliPos.lng, data.lat, data.lng);
                        document.getElementById('msg').innerText = `O entregador est치 a ${Math.round(d)}m de dist칙ncia.`;
                        
                        // PROTOCOLO DE CHEGADA (abaixo de 200 metros)
                        if(d < 200 && !jaAvisou) {
                            // 1. Chamada T치til (Vibra칞칚o)
                            if("vibrate" in navigator) navigator.vibrate([500, 300, 500, 300, 500]);
                            
                            // 2. Chamada Sonora
                            tocarAlerta();
                            
                            // 3. Chamada Visual
                            document.body.classList.add('chegou');
                            document.getElementById('titulo').innerHTML = "游뚿 ELE CHEGOU!";
                            document.getElementById('msg').innerHTML = "<b>V치 para o port칚o agora.</b><br>Ajude-nos a manter o sil칡ncio!";
                            
                            jaAvisou = true;
                        }
                    } else {
                        document.getElementById('msg').innerText = "Em rota. Acompanhe pelo mapa!";
                    }
                }
            });
        } else {
            document.getElementById('titulo').innerText = "Erro no Link";
            document.getElementById('msg').innerText = "Pe칞a um novo link ao lojista.";
        }
    </script>
</body>
</html>
